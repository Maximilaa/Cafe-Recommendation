# -*- coding: utf-8 -*-
"""app
Automatically generated by Colab.
Original file is located at
    https://colab.research.google.com/drive/16gW4FijDtLhFvXKEszsGFFbm83PYFFSf
"""

import streamlit as st
import pandas as pd
import torch
import numpy as np
from transformers import BertTokenizer, BertModel
from sklearn.metrics.pairwise import cosine_similarity
from huggingface_hub import hf_hub_download

# =========================
# CONFIG
# =========================
st.set_page_config(
    page_title="Coffee Insight AI",
    layout="wide"
)

ALPHA = 0.7   # bobot hybrid (sesuai Bab II & IV)
TOP_N = 5

# =========================
# LOAD ASSETS
# =========================
@st.cache_resource
def load_assets():
    # dataset hasil preprocessing
    df = pd.read_csv("processed_coffee.csv")

    # download model embedding (BERT fine-tuned)
    REPO_ID = "lattezice/cafe-sentiment-bert"
    model_path = hf_hub_download(
        repo_id=REPO_ID,
        filename="bert_embedding.pt"
    )

    tokenizer = BertTokenizer.from_pretrained("bert-base-uncased")
    model = BertModel.from_pretrained("bert-base-uncased")

    device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
    model.load_state_dict(torch.load(model_path, map_location=device))
    model.to(device)
    model.eval()

    # load precomputed cafe profile
    cafe_emb = np.load("cafe_embedding.npy")      # (n_cafe, 768)
    sentiment_score = np.load("sentiment_score.npy")  # (n_cafe,)

    return df, tokenizer, model, cafe_emb, sentiment_score, device


df, tokenizer, model, cafe_emb_matrix, sentiment_score_vec, device = load_assets()

# =========================
# HELPER FUNCTION
# =========================
def encode_text(text):
    inputs = tokenizer(
        text,
        return_tensors="pt",
        truncation=True,
        padding=True,
        max_length=256
    ).to(device)

    with torch.no_grad():
        outputs = model(**inputs)
        emb = outputs.last_hidden_state[:, 0, :]  # CLS token

    return emb.cpu().numpy().flatten()


# =========================
# UI
# =========================
st.title("â˜• Coffee Insight AI")
st.markdown("Sistem Rekomendasi CafÃ© Berbasis Embedding & Sentimen")

with st.form("recommender_form"):
    user_text = st.text_area(
        "Preferensi CafÃ© (contoh: cozy quiet place for studying)",
        height=120
    )

    col1, col2 = st.columns(2)
    with col1:
        city = st.selectbox("City", sorted(df["city"].dropna().unique()))
    with col2:
        state = st.selectbox("State", sorted(df["state"].dropna().unique()))

    submitted = st.form_submit_button("Cari Rekomendasi")

# =========================
# RECOMMENDATION LOGIC
# =========================
if submitted:
    if user_text.strip() == "":
        st.warning("Masukkan preferensi cafÃ© terlebih dahulu.")
    else:
        # encode user preference
        user_emb = encode_text(user_text).reshape(1, -1)

        # similarity
        similarity_scores = cosine_similarity(
            user_emb,
            cafe_emb_matrix
        )[0]

        # hybrid score
        hybrid_scores = (
            ALPHA * similarity_scores
            + (1 - ALPHA) * sentiment_score_vec
        )

        # build result table
        result_df = df.copy()
        result_df["similarity_score"] = similarity_scores
        result_df["sentiment_score"] = sentiment_score_vec
        result_df["hybrid_score"] = hybrid_scores

        # filter lokasi
        result_df = result_df[
            (result_df["city"] == city) &
            (result_df["state"] == state)
        ]

        # ranking
        result_df = (
            result_df
            .sort_values("hybrid_score", ascending=False)
            .drop_duplicates("business_id")
            .head(TOP_N)
        )

        # output
        st.subheader("ðŸŽ¯ Rekomendasi CafÃ©")
        st.dataframe(
            result_df[
                ["cafe_name", "cafe_rating", "hybrid_score"]
            ].reset_index(drop=True)
        )

