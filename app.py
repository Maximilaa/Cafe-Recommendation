# -*- coding: utf-8 -*-
"""app
Automatically generated by Colab.
Original file is located at
    https://colab.research.google.com/drive/16gW4FijDtLhFvXKEszsGFFbm83PYFFSf
"""

import streamlit as st
import pandas as pd
import torch
import os
from transformers import BertTokenizer, BertForSequenceClassification
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from huggingface_hub import hf_hub_download

# --- CONFIG & LOAD ASSETS ---
st.set_page_config(page_title="Coffee Insight AI", layout="wide")

@st.cache_resource
def load_assets():
    # 1. Load Data Bersih
    df = pd.read_csv('processed_coffee.csv')

    # 2. Download model dari Hugging Face secara otomatis
    # GANTI "username/repo" dengan nama yang kamu buat di Hugging Face tadi
    REPO_ID = "lattezice/cafe-sentiment-bert" 
    model_file = hf_hub_download(repo_id=REPO_ID, filename="best_model.pt")

    # 3. Inisialisasi Arsitektur BERT
    tokenizer = BertTokenizer.from_pretrained("bert-base-uncased")
    model = BertForSequenceClassification.from_pretrained("bert-base-uncased", num_labels=3)

    # 4. Load bobot model yang sudah didownload
    device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
    model.load_state_dict(torch.load(model_file, map_location=device))
    model.eval()

    return df, tokenizer, model

# --- LOGIKA REKOMENDASI ---
def get_recs(cafe_name, dataframe):
    tfidf = TfidfVectorizer(stop_words='english')
    # Sesuaikan 'categories' dengan nama kolom kategori di datasetmu
    tfidf_matrix = tfidf.fit_transform(dataframe['categories'].fillna(''))
    cosine_sim = cosine_similarity(tfidf_matrix, tfidf_matrix)

    idx = dataframe[dataframe['name'] == cafe_name].index[0]
    sim_scores = list(enumerate(cosine_sim[idx]))
    sim_scores = sorted(sim_scores, key=lambda x: x[1], reverse=True)[1:6]

    return dataframe.iloc[[i[0] for i in sim_scores]]

# --- UI DESIGN ---
st.title("‚òï Coffee Insight AI")
st.markdown("Dashboard Analisis Sentimen & Rekomendasi Pintar")

tab1, tab2 = st.tabs(["üîç Cek Sentimen Ulasan", "üéØ Rekomendasi Kafe"])

# TAB SENTIMEN
with tab1:
    st.subheader("Beri Tahu Kami Pendapatmu")
    input_text = st.text_area("Tulis ulasan di sini...", height=100)

    if st.button("Analisis"):
        if input_text:
            inputs = tokenizer(input_text, return_tensors="pt", truncation=True, padding=True, max_length=320)
            with torch.no_grad():
                outputs = model(**inputs)
                pred = torch.argmax(outputs.logits, dim=-1).item()

            # Sesuaikan label dengan LabelEncoder di notebook-mu
            mapping = {2: "Negatif üò°", 1: "Netral üòê", 0: "Positif üòç"}
            st.info(f"Hasil Analisis: **{mapping[pred]}**")
        else:
            st.warning("Masukkan ulasan dulu ya!")

# TAB REKOMENDASI
with tab2:
    st.subheader("Cari Kafe yang Mirip")
    pilihan = st.selectbox("Pilih Kafe yang Kamu Suka:", df['name'].unique())

    if st.button("Tampilkan Rekomendasi"):
        hasil = get_recs(pilihan, df)
        st.write(f"Berdasarkan **{pilihan}**, kamu mungkin juga suka kafe ini:")

        for _, row in hasil.iterrows():
            with st.expander(f"üìç {row['name']} ({row['stars']} ‚≠ê)"):
                st.write(f"**Kategori:** {row['categories']}")
                st.write(f"**Lokasi:** {row['city']}")
